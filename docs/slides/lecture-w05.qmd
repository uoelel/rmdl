---
title: "Research Methods in Developmental Linguistics -- Week 5"
author: "Dr Stefano Coretta"
institute: "University of Edinburgh"
execute: 
  echo: true
knitr:
  opts_chunk:
    dev: "ragg_png"
---

```{r setup, include=FALSE}
library(tidyverse)
theme_set(theme_light())

library(brms)
library(tidybayes)
library(posterior)

options(ggplot2.discrete.fill = RColorBrewer::brewer.pal(8, "Dark2"))
options(ggplot2.discrete.colour = RColorBrewer::brewer.pal(8, "Dark2"))
options(show.signif.stars = FALSE)

my_seed <- 9283
set.seed(my_seed)
options(scipen = 999)
```

## Case study: Ota 2009

::: {.callout-note appearance="simple"}
-   Data from [Ota 2009](https://doi.org/10.1016/j.cognition.2008.12.007).

-   L2 lexical representation of "near-homophones": ROCK/LOCK for Japanese speakers.
:::

![](/img/l1-l2-reps.png){fig-align="center"}

## Ota 2009: design

::: {.callout-note appearance="simple"}
-   Semantic-relatedness task.

-   Pairs of written words presented visually.

    -   **Homophones**: SON/SUN \~ MOON

    -   **Near-homophones**: ROCK/LOCK \~ KEY

    -   **Minimal pairs**: PEAR/BEAR \~ FEAR
:::

. . .

::: callout-warning
## Research hypotheses

H1.
The difference in RTs between unrelated and control is the same in homophones (H) and near-homophones (LR).

H2.
There is no difference in RTs in minimal pairs (PB).
:::

## Ota 2009: the data

```{r}
#| label: ota2009-read

ota2009 <- read_csv("data/ota2009/key-rock.csv") |>
  filter(
    Procedure == "TrialProc", Contrast != "F"
  ) |>
  mutate(
    Subject = as.factor(Subject),
    RT_log = log(Words.RT),
    Item_id = paste(Version, Contrast, Item, sep = "_")
  )
```

## Ota 2009: the data

```{r}
#| label: ota2009

ota2009
```


## Ota 2009: RTs

```{r}
#| label: fig-contr-cond
#| fig-cap: "Logged RTs in three contrasts and two conditions."
#| echo: false

emo <- tibble(
  label = c("â˜€ï¸-ðŸŒ™", "ðŸ‘¦-ðŸŒ™", "ðŸ”’-ðŸ”‘", "ðŸª¨-ðŸ”‘", "ðŸ»-ðŸ˜±", "ðŸ-ðŸ˜±"),
  Condition = c(rep(c("control", "unrelated"), 3)),
  Contrast = c(rep(c("H", "LR", "PB"), each = 2)),
  RT_log = 6.5
)

ota2009 |> 
  ggplot(aes(Contrast, RT_log)) +
  geom_violin(aes(fill = Condition), alpha = 0.2) +
  geom_jitter(
    aes(colour = Condition), alpha = 0.4,
    position = position_jitterdodge(jitter.width = 0.1, dodge.width = 0.9)
  ) +
  stat_summary(
    aes(group = Condition),
    position = position_dodge(width = 0.9),
    fun = "median", geom = "point", size = 3
  ) +
  geom_text(data = emo, aes(label = label, group = Condition), position = position_dodge(width = 0.9), size = 5)
```

## Log-normal regression (RTs)

```{r}
#| label: ota-bm-1
#| echo: true

my_seed <- 9283

ota_bm_1 <- brm(
  # Word.RT ~ Condition + Contrast + Condition:Contrast
  Words.RT ~ Condition * Contrast,
  family = lognormal,
  data = ota2009,
  seed = my_seed,
  cores = 4,
  file = "data/cache/ota_bm_1"
)
```

## Log-normal regression: summary

```{r}
#| label: ota-bm-1-sum

summary(ota_bm_1, prob = 0.9)
```

## Log-normal regression: expected values

```{r}
#| label: ota-bm-1-cond

conditional_effects(ota_bm_1, effects = "Contrast:Condition")

```

## BUT...

::: {.callout-error appearance="simple"}
-   Multiple observations from different participants.

-   Multiple observations from different item lists.
:::

. . .

::: {.callout-tip appearance="simple"}
-   We need to include **varying terms** (also known as random or multilevel effects).

-   Regression models with varying terms are variably known as mixed-effects, multilevel, hierarchical, nested...
    They are all the same thing.
:::

## By-subject RTs

```{r}
#| label: fig-subj-rts
#| fig-cap: "Log-RTs in the LR condition by subject"
#| fig_asp: 0.5
#| echo: false

ota2009 |>
  filter(Contrast == "LR") |>
  ggplot(aes(Condition, RT_log)) +
  geom_jitter(
    aes(colour = Condition), alpha = 0.4,
    position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9)
  ) +
  stat_summary(
    aes(group = Condition),
    position = position_dodge(width = 0.9),
    fun.data = "mean_cl_boot"
  ) +
  facet_wrap(~ Subject, nrow = 2) +
  theme(axis.text.x = element_blank(), legend.position = "bottom")
```

## By-list RTs

```{r}
#| label: fig-list-rts
#| fig-cap: "Log-RTs in the LR condition by list"
#| fig_asp: 0.5
#| echo: false

ota2009 |>
  filter(Contrast == "LR") |>
  ggplot(aes(Condition, RT_log)) +
  geom_jitter(
    aes(colour = Condition), alpha = 0.4,
    position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9)
  ) +
  stat_summary(
    aes(group = Condition),
    position = position_dodge(width = 0.9),
    fun.data = "mean_cl_boot"
  ) +
  facet_grid(cols = vars(Version)) +
  theme(axis.text.x = element_blank(), legend.position = "bottom")
```

## By-subject varying intercept

```{r}
#| label: ota-bm-2
#| echo: true

ota_bm_2 <- brm(
  Words.RT ~ 1 + (1 | Subject),
  family = lognormal,
  data = ota2009,
  seed = my_seed,
  cores = 4,
  file = "data/cache/ota_bm_2"
)
```

## Model summary

```{r}
#| label: ota-bm-2-summ

summary(ota_bm_2, prob = 0.9)
```

## Model draws

```{r}
#| label: ota-bm-2-draws
#| echo: true

ota_bm_2_draws <- as_draws_df(ota_bm_2)
ota_bm_2_draws
```

## Model plot

```{r}
#| label: ota-bm-2-plot

plot(ota_bm_2)
```


## By-subject varying intercept and slope

```{r}
#| label: ota-bm-3
#| echo: true

ota_bm_3 <- brm(
  Words.RT ~ Condition +
    (Condition | Subject),
  family = lognormal,
  data = ota2009,
  seed = my_seed,
  cores = 4,
  file = "data/cache/ota_bm_3"
)
```

## Model summary

```{r}
#| label: ota-bm-3-summ
#| echo: true

summary(ota_bm_3, prob = 0.9)
```

## Model draws

```{r}
#| label: ota-bm-3-draws

ota_bm_3_draws <- as_draws_df(ota_bm_3)
ota_bm_3_draws
```


## Expected values

```{r}
#| label: ota-bm-3-cond

conditional_effects(ota_bm_3)
```

## By-subject varying intercept and slopes

```{r}
#| label: ota-bm-4
#| echo: true

ota_bm_4 <- brm(
  Words.RT ~ Condition * Contrast +
    (Condition * Contrast | Subject),
  family = lognormal,
  data = ota2009,
  seed = my_seed,
  cores = 4,
  file = "data/cache/ota_bm_4"
)
```

## Model summary

```{r}
#| label: ota-bm-4-summ

summary(ota_bm_4, prob = 0.9)
```

## Expected values

```{r}
#| label: ota-bm-4-cond

conditional_effects(ota_bm_4, "Contrast:Condition")
```

## Expected values (without varying terms)

```{r}
#| label: ota-bm-1-cond-2

conditional_effects(ota_bm_1, effects = "Contrast:Condition")

```

## Constant (fixed) effects

```{r}
#| label: ota-bm-4-fixef
#| echo: true

fixef(ota_bm_4, probs = c(0.05, 0.95)) |> round(2)

fixef(ota_bm_1, probs = c(0.05, 0.95)) |> round(2)
```

## Effect of condition in PB: calculate

```{r}
ota_bm_4_draws <- as_draws_df(ota_bm_4) |> 
  mutate(
    unrel_h = b_ConditionUnrelated,
    unrel_lr = b_ConditionUnrelated + `b_ConditionUnrelated:ContrastLR`,
    unrel_pb = b_ConditionUnrelated + `b_ConditionUnrelated:ContrastPB`
  )

quantile2(ota_bm_4_draws$unrel_pb) |> round(2)
```

## Effect of condition in PB: plot

```{r}
#| label: fig-cond-effect
#| fig-cap: "Effect of 'unrelated' in three contrasts."
#| echo: false
#| warning: false

ota_bm_4_draws |> 
  pivot_longer(unrel_h:unrel_pb) |> 
  ggplot(aes(value, name)) +
  geom_vline(xintercept = 0) +
  stat_halfeye() +
  xlim(-0.1, 0.25)
```

## Difference of effect of condition in H and LR

```{r}
ota_bm_4_draws <- ota_bm_4_draws |> 
  mutate(
    unrel_h_lr = unrel_h - unrel_lr
  )

quantile2(ota_bm_4_draws$unrel_h_lr) |> round(2)
```


## Results overview

::: {.callout-note appearance="simple"}
H1.
The difference in RTs between unrelated and control is the same in homophones (H) and near-homophones (LR).

-   **Not enough evidence to assess** (90% CrI \[-0.4, 0.12\]).

H2.
There is no difference in RTs in minimal pairs (PB).

-   **Not enough evidence to assess** (90% CrI \[-0.02, 0.10\]).
:::

## Summary

::: {.callout-tip appearance="simple"}
-   You should include varying terms if data is "hierarchical", for example repeated measures from subjects or items.

-   Not including varying terms (wrongly) inflates posterior certainty.

-   Frequentist regression models with lme4 often don't converge and researchers simplify the hierarchical structure of the model.
:::
